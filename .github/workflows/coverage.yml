name: Code Coverage

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write
  issues: write

env:
  CMAKE_BUILD_PARALLEL_LEVEL: 4
  MAKEFLAGS: "-j4"
  CACHE_VERSION: v2
  APP_NAME: sast-readium

jobs:
  # Code coverage collection (Linux)
  coverage-linux:
    name: Code Coverage (Linux)
    runs-on: ubuntu-latest
    timeout-minutes: 60
    container: ubuntu:22.04

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'
          fetch-depth: 1

      - name: Install system dependencies
        run: |
          apt-get update
          apt-get install -y \
            cmake ninja-build build-essential \
            gcovr lcov \
            qt6-base-dev qt6-svg-dev qt6-tools-dev qt6-l10n-tools \
            libpoppler-qt6-dev pkg-config \
            git python3 python3-pip

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        run: |
          pip install --upgrade pip
          pip install gcovr requests

      - name: Configure CMake with Coverage
        run: |
          cmake --preset=Debug-Unix \
            -DUSE_VCPKG=OFF \
            -DCMAKE_BUILD_TYPE=Debug \
            -DCMAKE_CXX_FLAGS="--coverage -g -O0" \
            -DCMAKE_C_FLAGS="--coverage -g -O0" \
            -DCMAKE_EXE_LINKER_FLAGS="--coverage" \
            -DCMAKE_SHARED_LINKER_FLAGS="--coverage"

      - name: Build with Coverage
        run: |
          cmake --build --preset=Debug-Unix --parallel 4

      - name: Run Tests with Coverage
        run: |
          cd build/Debug
          ctest --output-on-failure --parallel 4

      - name: Generate Coverage Report
        run: |
          cd build/Debug
          # Generate LCOV info
          lcov --capture --directory . --output-file coverage.info
          lcov --remove coverage.info '/usr/*' --output-file coverage.info
          lcov --remove coverage.info '*/tests/*' --output-file coverage.info
          lcov --remove coverage.info '*/test_*' --output-file coverage.info
          lcov --list coverage.info

          # Generate XML for Codecov
          gcovr --xml --output coverage.xml --exclude '.*/tests/.*' --exclude '.*/test_.*' .

          # Generate HTML report
          gcovr --html --html-details --output coverage.html --exclude '.*/tests/.*' --exclude '.*/test_.*' .

      - name: Upload Coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          file: ./build/Debug/coverage.info
          files: ./build/Debug/coverage.xml
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false

      - name: Upload Coverage Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports-linux
          path: |
            build/Debug/coverage.info
            build/Debug/coverage.xml
            build/Debug/coverage.html
          retention-days: 30

      - name: Coverage Summary
        run: |
          cd build/Debug
          echo "## Code Coverage Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Extract coverage percentage
          COVERAGE_PCT=$(lcov --summary coverage.info 2>&1 | grep -E 'lines\.\.\.:|total:' | tail -1 | grep -o '[0-9.]*%' | head -1)
          if [ -z "$COVERAGE_PCT" ]; then
            COVERAGE_PCT="N/A"
          fi

          echo "**Overall Coverage:** $COVERAGE_PCT" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Show coverage by file (top 10)
          echo "### Coverage by File (Top 10)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          lcov --summary coverage.info 2>&1 | grep -E '\.cpp|\.hpp' | head -10 | while read line; do
            echo "- $line" >> $GITHUB_STEP_SUMMARY
          done

  # Coverage collection (Windows with MSYS2)
  coverage-windows:
    name: Code Coverage (Windows)
    runs-on: windows-latest
    timeout-minutes: 60
    defaults:
      run:
        shell: msys2 {0}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'
          fetch-depth: 1

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Setup MSYS2
        uses: msys2/setup-msys2@v2
        with:
          msystem: ucrt64
          update: true
          install: >-
            mingw-w64-ucrt-x86_64-cmake
            mingw-w64-ucrt-x86_64-ninja
            mingw-w64-ucrt-x86_64-gcc
            mingw-w64-ucrt-x86_64-qt6-base
            mingw-w64-ucrt-x86_64-qt6-svg
            mingw-w64-ucrt-x86_64-qt6-tools
            mingw-w64-ucrt-x86_64-poppler-qt6
            mingw-w64-ucrt-x86_64-pkg-config
            mingw-w64-ucrt-x86_64-lcov
            git

      - name: Configure CMake with Coverage
        run: |
          cmake --preset=Debug-MSYS2 \
            -DCMAKE_BUILD_TYPE=Debug \
            -DCMAKE_CXX_FLAGS="--coverage -g -O0" \
            -DCMAKE_C_FLAGS="--coverage -g -O0" \
            -DCMAKE_EXE_LINKER_FLAGS="--coverage" \
            -DCMAKE_SHARED_LINKER_FLAGS="--coverage"

      - name: Build with Coverage
        run: |
          cmake --build --preset=Debug-MSYS2 --parallel 4

      - name: Run Tests with Coverage
        run: |
          cd build/Debug-MSYS2
          ctest --output-on-failure --parallel 4

      - name: Generate Coverage Report
        run: |
          cd build/Debug-MSYS2
          # Generate coverage report
          gcov --relative --preserve-paths --object-directory . ../*.cpp ../*.c

          # Generate XML report (if gcovr is available)
          if command -v gcovr &> /dev/null; then
            gcovr --xml --output coverage.xml --exclude '.*/tests/.*' --exclude '.*/test_.*' .
          fi

      - name: Upload Coverage Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports-windows
          path: |
            build/Debug-MSYS2/*.gcov
            build/Debug-MSYS2/coverage.xml
          retention-days: 30

  # Coverage Comparison and Trends
  coverage-analysis:
    name: Coverage Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: [coverage-linux, coverage-windows]
    if: always()

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Coverage Reports
        uses: actions/download-artifact@v4
        with:
          path: coverage-artifacts

      - name: Analyze Coverage Trends
        run: |
          echo "# Coverage Analysis Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f "coverage-artifacts/coverage-reports-linux/build/Debug/coverage.info" ]; then
            cd coverage-artifacts/coverage-reports-linux/build/Debug

            echo "## Linux Coverage Metrics" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            # Get overall coverage
            COVERAGE_SUMMARY=$(lcov --summary coverage.info 2>&1)
            echo "### Overall Coverage" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "$COVERAGE_SUMMARY" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            # Find low coverage files
            echo "### Files Needing More Coverage (< 80%)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            lcov --summary coverage.info 2>&1 | grep -E '\.cpp|\.hpp' | while read line; do
              if echo "$line" | grep -E '[0-9]+\.[0-9]+%' | grep -vE '[8-9][0-9]\.[0-9]+%|100\.0%'; then
                echo "- $line" >> $GITHUB_STEP_SUMMARY
              fi
            done
          else
            echo "âŒ Linux coverage report not found" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Coverage Recommendations" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Focus on increasing coverage for core functionality" >> $GITHUB_STEP_SUMMARY
          echo "- Add unit tests for poorly covered utility functions" >> $GITHUB_STEP_SUMMARY
          echo "- Consider integration tests for complex user workflows" >> $GITHUB_STEP_SUMMARY
          echo "- Set up coverage badges in README" >> $GITHUB_STEP_SUMMARY
