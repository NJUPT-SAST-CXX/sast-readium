name: Documentation

on:
  push:
    branches: [ master, main ]
    paths:
      - 'docs/**'
      - '**.md'
      - 'README.md'
      - 'CHANGELOG.md'
  pull_request:
    branches: [ master, main ]
    paths:
      - 'docs/**'
      - '**.md'
      - 'README.md'
      - 'CHANGELOG.md'
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

env:
  APP_NAME: sast-readium

jobs:
  # Build documentation
  build-docs:
    name: Build Documentation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'
          fetch-depth: 1

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install documentation tools
        run: |
          pip install --upgrade pip
          pip install mkdocs mkdocs-material mkdocs-mermaid2-plugin \
                     mkdocs-git-revision-date-localized-plugin \
                     mkdocs-git-committers-plugin-2 mkdocs-minify-plugin \
                     mkdocs-search-plugin mkdocs-awesome-pages-plugin

      - name: Install Doxygen
        run: |
          sudo apt-get update
          sudo apt-get install -y doxygen graphviz

      - name: Validate Documentation Structure
        run: |
          echo "## Documentation Structure Validation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check if docs directory exists
          if [ -d "docs" ]; then
            echo "✅ Documentation directory found" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            # List documentation files
            echo "### Documentation Files" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            find docs -name "*.md" -type f | head -20 | while read file; do
              echo "- $file" >> $GITHUB_STEP_SUMMARY
            done
          else
            echo "❌ Documentation directory not found" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Creating basic documentation structure..." >> $GITHUB_STEP_SUMMARY
            mkdir -p docs
          fi

          # Check for key documentation files
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Key Documentation Files" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          for file in README.md CHANGELOG.md LICENSE; do
            if [ -f "$file" ]; then
              echo "- ✅ $file" >> $GITHUB_STEP_SUMMARY
            else
              echo "- ❌ $file (missing)" >> $GITHUB_STEP_SUMMARY
            fi
          done

      - name: Generate API Documentation (Doxygen)
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## API Documentation Generation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check for Doxygen configuration
          if [ -f "Doxyfile" ]; then
            echo "✅ Doxygen configuration found" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            # Generate API documentation
            doxygen Doxyfile 2> doxygen.log || true

            if [ -d "docs/api" ]; then
              echo "✅ API documentation generated successfully" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY

              # Count generated files
              API_FILES=$(find docs/api -name "*.html" | wc -l)
              echo "- Generated $API_FILES HTML files" >> $GITHUB_STEP_SUMMARY

              # List key sections
              echo "- Key sections:" >> $GITHUB_STEP_SUMMARY
              for section in "annotated.html" "classes.html" "files.html" "namespaces.html"; do
                if [ -f "docs/api/$section" ]; then
                  echo "  - ✅ $section" >> $GITHUB_STEP_SUMMARY
                fi
              done
            else
              echo "❌ API documentation generation failed" >> $GITHUB_STEP_SUMMARY
              if [ -f "doxygen.log" ]; then
                echo "Check doxygen.log for errors" >> $GITHUB_STEP_SUMMARY
              fi
            fi
          else
            echo "⚠️ Doxygen configuration not found" >> $GITHUB_STEP_SUMMARY
            echo "Creating basic Doxygen configuration..." >> $GITHUB_STEP_SUMMARY

            # Create basic Doxygen configuration
            cat > Doxyfile << 'EOF'
PROJECT_NAME           = "SAST Readium"
PROJECT_NUMBER         = "0.1.0"
OUTPUT_DIRECTORY       = docs/api
INPUT                  = app tests
RECURSIVE              = YES
GENERATE_HTML          = YES
GENERATE_LATEX         = NO
GENERATE_TREEVIEW      = YES
TREEVIEW_WIDTH         = 250
EXTRACT_ALL            = YES
EXTRACT_STATIC         = YES
EXTRACT_LOCAL_CLASSES  = YES
HIDE_UNDOC_MEMBERS     = NO
HIDE_UNDOC_CLASSES     = NO
HIDE_FRIEND_COMPOUNDS  = NO
HIDE_IN_BODY_DOCS      = NO
INTERNAL_DOCS          = NO
CASE_SENSE_NAMES       = YES
HIDE_SCOPE_NAMES       = NO
SHOW_INCLUDE_FILES     = YES
SORT_MEMBER_DOCS       = YES
SORT_BRIEF_DOCS        = NO
SORT_BY_SCOPE_NAME     = YES
GENERATE_TODOLIST      = YES
GENERATE_TESTLIST      = YES
GENERATE_BUGLIST       = YES
GENERATE_DEPRECATEDLIST = YES
ENABLE_PREPROCESSING   = YES
MACRO_EXPANSION        = YES
EXPAND_ONLY_PREDEF     = NO
SEARCH_INCLUDES        = YES
INCLUDE_GRAPH          = YES
INCLUDED_BY_GRAPH      = YES
CALL_GRAPH             = NO
CALLER_GRAPH           = NO
GRAPHICAL_HIERARCHY    = YES
DIRECTORY_GRAPH        = YES
DOT_IMAGE_FORMAT       = png
INTERACTIVE_SVG        = NO
DOT_PATH               = /usr/bin
DOT_CLEANUP            = YES
EOF

            echo "Created basic Doxyfile" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Create MkDocs Configuration
        run: |
          # Create MkDocs configuration if it doesn't exist
          if [ ! -f "mkdocs.yml" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Creating MkDocs Configuration" >> $GITHUB_STEP_SUMMARY

            cat > mkdocs.yml << 'EOF'
site_name: SAST Readium Documentation
site_description: Qt6-based PDF reader application documentation
site_author: SAST Team
site_url: https://sast-team.github.io/sast-readium/

repo_name: sast-team/sast-readium
repo_url: https://github.com/sast-team/sast-readium
edit_uri: edit/main/docs/

nav:
  - Home: index.md
  - Getting Started:
    - Installation: getting-started/installation.md
    - Quick Start: getting-started/quick-start.md
    - Configuration: getting-started/configuration.md
  - User Guide:
    - Basic Usage: user-guide/basic-usage.md
    - Search Features: user-guide/search-features.md
    - PDF Navigation: user-guide/pdf-navigation.md
    - Preferences: user-guide/preferences.md
  - Developer Guide:
    - Architecture: developer-guide/architecture.md
    - Building: developer-guide/building.md
    - Testing: developer-guide/testing.md
    - Contributing: developer-guide/contributing.md
  - API Reference:
    - API Documentation: api/index.md
  - About:
    - Changelog: about/changelog.md
    - License: about/license.md
    - Security: about/security.md

theme:
  name: material
  palette:
    - scheme: default
      primary: blue-grey
      accent: light-blue
      toggle:
        icon: material/brightness-7
        name: Switch to dark mode
    - scheme: slate
      primary: blue-grey
      accent: light-blue
      toggle:
        icon: material/brightness-4
        name: Switch to light mode
  font:
    text: Roboto
    code: Roboto Mono
  features:
    - navigation.tabs
    - navigation.tabs.sticky
    - navigation.sections
    - navigation.expand
    - navigation.indexes
    - navigation.top
    - search.highlight
    - search.share
    - content.code.copy
    - content.code.annotate
  language: en

plugins:
  - search
  - git-revision-date-localized:
      type: datetime
      timezone: UTC
      locale: en
      enable_creation_date: true
  - git-committers:
      repository: sast-team/sast-readium
      branch: main
  - awesome-pages
  - minify:
      minify_html: true

markdown_extensions:
  - abbr
  - admonition
  - attr_list
  - def_list
  - footnotes
  - meta
  - md_in_html
  - toc:
      permalink: true
  - pymdownx.arithmatex:
      generic: true
  - pymdownx.betterem:
      smart_enable: all
  - pymdownx.caret
  - pymdownx.details
  - pymdownx.emoji:
      emoji_generator: !!python/name:material.extensions.emoji.to_svg
      emoji_index: !!python/name:material.extensions.emoji.twemoji
  - pymdownx.highlight:
      anchor_linenums: true
      line_spans: __span
      pygments_lang_class: true
  - pymdownx.inlinehilite
  - pymdownx.keys
  - pymdownx.magiclink:
      normalize_issue_symbols: true
      repo_url_shorthand: true
      user: sast-team
      repo: sast-readium
  - pymdownx.mark
  - pymdownx.smartsymbols
  - pymdownx.snippets:
      auto_append:
        - includes/mkdocs.md
  - pymdownx.superfences:
      custom_fences:
        - name: mermaid
          class: mermaid
          format: !!python/name:pymdownx.superfences.fence_code_format
  - pymdownx.tabbed:
      alternate_style: true
      combine_header_slug: true
      slugify: !!python/object/apply:pymdownx.slugs.slugify
        kwds:
          case: lower
  - pymdownx.tasklist:
      custom_checkbox: true
  - pymdownx.tilde

extra:
  analytics:
    provider: google
    property: !ENV GOOGLE_ANALYTICS_KEY
  social:
    - icon: fontawesome/brands/github
      link: https://github.com/sast-team/sast-readium
    - icon: fontawesome/brands/docker
      link: https://hub.docker.com/r/sastteam/sast-readium

extra_css:
  - stylesheets/extra.css

extra_javascript:
  - javascripts/mathjax.js
  - https://polyfill.io/v3/polyfill.min.js?features=es6
  - https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js

copyright: |
  &copy; 2024 SAST Team - Built with
  <a href="https://www.mkdocs.org/">MkDocs</a> and
  <a href="https://squidfunk.github.io/mkdocs-material/">Material for MkDocs</a>
EOF

            echo "✅ Created mkdocs.yml" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Create Documentation Structure
        run: |
          # Create basic documentation structure
          mkdir -p docs/{getting-started,user-guide,developer-guide,about,api}

          # Create index.md if it doesn't exist
          if [ ! -f "docs/index.md" ]; then
            cat > docs/index.md << 'EOF'
# SAST Readium

Welcome to the SAST Readium documentation!

## What is SAST Readium?

SAST Readium is a modern Qt6-based PDF reader application designed for security analysis and document inspection. It provides advanced features for PDF viewing, searching, and analysis.

## Key Features

- **Modern Qt6 Interface**: Clean, responsive user interface
- **Advanced Search**: Powerful search capabilities with regex support
- **PDF Analysis**: Tools for document security analysis
- **Cross-Platform**: Works on Windows, Linux, and macOS
- **High Performance**: Optimized rendering and memory usage

## Quick Start

1. [Download and install](getting-started/installation.md) the application
2. [Configure](getting-started/configuration.md) your preferences
3. Start analyzing PDF documents!

## Documentation

- [Getting Started](getting-started/installation.md)
- [User Guide](user-guide/basic-usage.md)
- [Developer Guide](developer-guide/architecture.md)
- [API Reference](api/index.md)

## Support

If you encounter any issues or have questions:

- Check the [troubleshooting guide](user-guide/troubleshooting.md)
- [Search existing issues](https://github.com/sast-team/sast-readium/issues)
- [Create a new issue](https://github.com/sast-team/sast-readium/issues/new)

## Contributing

We welcome contributions! See the [contributing guide](developer-guide/contributing.md) for details.
EOF
          fi

          # Create additional key documentation files
          cat > docs/getting-started/installation.md << 'EOF'
# Installation

## System Requirements

- **Operating System**: Windows 10+, macOS 10.15+, or Linux (Ubuntu 20.04+)
- **Memory**: 4GB RAM minimum (8GB recommended)
- **Storage**: 500MB free space
- **Graphics**: OpenGL 2.0+ support

## Installation Methods

### Windows

#### Using the Installer (Recommended)
1. Download the latest installer from the [releases page](https://github.com/sast-team/sast-readium/releases)
2. Run the installer executable
3. Follow the installation wizard
4. Launch SAST Readium from the Start menu

#### Using MSYS2
```bash
pacman -S mingw-w64-ucrt-x86_64-sast-readium
```

#### Using Chocolatey
```bash
choco install sast-readium
```

### macOS

#### Using the Installer
1. Download the latest `.dmg` file from the [releases page](https://github.com/sast-team/sast-readium/releases)
2. Open the downloaded file
3. Drag SAST Readium to your Applications folder
4. Launch from Launchpad or Applications folder

#### Using Homebrew
```bash
brew install --cask sast-readium
```

### Linux

#### Ubuntu/Debian
```bash
# Add PPA repository
sudo add-apt-repository ppa:sast-team/sast-readium
sudo apt update

# Install the application
sudo apt install sast-readium
```

#### Fedora
```bash
sudo dnf install sast-readium
```

#### Arch Linux
```bash
yay -S sast-readium
```

#### Using AppImage
1. Download the latest AppImage from the [releases page](https://github.com/sast-team/sast-readium/releases)
2. Make the file executable:
   ```bash
   chmod +x sast-readium-*.AppImage
   ```
3. Run the application:
   ```bash
   ./sast-readium-*.AppImage
   ```

## Building from Source

For development or custom builds, see the [Building from Source](../developer-guide/building.md) section.

## Verification

After installation, verify the installation:

1. Launch SAST Readium
2. Check the Help → About dialog for version information
3. Test with a sample PDF file

## Troubleshooting

### Common Issues

- **Windows**: If you see a security warning, right-click and select "Run anyway"
- **macOS**: If you see "unidentified developer" error, go to System Preferences → Security & Privacy and click "Open Anyway"
- **Linux**: If you encounter library errors, ensure you have the required Qt6 dependencies installed

For more troubleshooting tips, see the [Troubleshooting Guide](../user-guide/troubleshooting.md).
EOF

          echo "✅ Created basic documentation structure" >> $GITHUB_STEP_SUMMARY

      - name: Build Documentation
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Documentation Build Process" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Build MkDocs site
          if command -v mkdocs &> /dev/null; then
            echo "Building MkDocs site..." >> $GITHUB_STEP_SUMMARY
            mkdocs build --strict 2> mkdocs-build.log || true

            if [ -d "site" ]; then
              echo "✅ Documentation built successfully" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY

              # Count generated files
              HTML_FILES=$(find site -name "*.html" | wc -l)
              TOTAL_SIZE=$(du -sh site | cut -f1)
              echo "- Generated $HTML_FILES HTML files" >> $GITHUB_STEP_SUMMARY
              echo "- Total size: $TOTAL_SIZE" >> $GITHUB_STEP_SUMMARY

              # List key pages
              echo "- Key pages generated:" >> $GITHUB_STEP_SUMMARY
              for page in "index.html" "getting-started/installation.html" "user-guide/basic-usage.html"; do
                if [ -f "site/$page" ]; then
                  echo "  - ✅ $page" >> $GITHUB_STEP_SUMMARY
                fi
              done
            else
              echo "❌ Documentation build failed" >> $GITHUB_STEP_SUMMARY
              if [ -f "mkdocs-build.log" ]; then
                echo "Check mkdocs-build.log for errors" >> $GITHUB_STEP_SUMMARY
              fi
            fi
          else
            echo "❌ MkDocs not available" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Validate Documentation Links
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Documentation Link Validation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Simple link validation for markdown files
          find docs -name "*.md" -type f | while read file; do
            echo "### Validating $file" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            # Extract markdown links
            grep -oE '\[.*?\]\([^)]+\)' "$file" | head -5 | while read link; do
              # Extract URL from markdown link
              URL=$(echo "$link" | sed -n 's/.*](\([^)]*\)).*/\1/p')
              echo "- $URL" >> $GITHUB_STEP_SUMMARY
            done
            echo "" >> $GITHUB_STEP_SUMMARY
          done

      - name: Upload Documentation Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: documentation-site
          path: |
            site/
            docs/api/
            mkdocs.yml
            Doxyfile
          retention-days: 30

  # Deploy documentation to GitHub Pages
  deploy-docs:
    name: Deploy Documentation
    runs-on: ubuntu-latest
    needs: build-docs
    if: github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main'

    permissions:
      pages: write
      id-token: write

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Documentation Artifacts
        uses: actions/download-artifact@v4
        with:
          name: documentation-site
          path: docs-built

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload to GitHub Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: docs-built/site

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Deployment Summary
        run: |
          echo "## Documentation Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ Documentation successfully deployed to GitHub Pages" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Live URL:** ${{ steps.deployment.outputs.page_url }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### What's Included" >> $GITHUB_STEP_SUMMARY
          echo "- User documentation" >> $GITHUB_STEP_SUMMARY
          echo "- Developer guide" >> $GITHUB_STEP_SUMMARY
          echo "- API documentation (Doxygen)" >> $GITHUB_STEP_SUMMARY
          echo "- Installation instructions" >> $GITHUB_STEP_SUMMARY
          echo "- Troubleshooting guides" >> $GITHUB_STEP_SUMMARY

  # Documentation Quality Checks
  docs-quality:
    name: Documentation Quality
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install quality check tools
        run: |
          pip install --upgrade pip
          pip install markdownlint-cli2

      - name: Run Markdown Linting
        run: |
          echo "## Documentation Quality Checks" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check markdown files
          if command -v markdownlint-cli2 &> /dev/null; then
            echo "### Markdown Linting Results" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            markdownlint-cli2 "docs/**/*.md" "*.md" 2> markdownlint-errors.txt || true

            if [ -s "markdownlint-errors.txt" ]; then
              echo "⚠️ Markdown linting issues found:" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              cat markdownlint-errors.txt | head -50 >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
            else
              echo "✅ No markdown linting issues found" >> $GITHUB_STEP_SUMMARY
            fi
          fi

      - name: Check Documentation Coverage
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Documentation Coverage Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Count documentation files
          TOTAL_MD_FILES=$(find . -name "*.md" | wc -l)
          DOCS_MD_FILES=$(find docs -name "*.md" | wc -l)
          README_SIZE=$(wc -l < README.md 2>/dev/null || echo "0")

          echo "- Total markdown files: $TOTAL_MD_FILES" >> $GITHUB_STEP_SUMMARY
          echo "- Documentation files: $DOCS_MD_FILES" >> $GITHUB_STEP_SUMMARY
          echo "- README.md lines: $README_SIZE" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check for key documentation sections
          echo "### Key Documentation Coverage" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          KEY_SECTIONS=(
            "Installation"
            "Getting Started"
            "Usage"
            "Configuration"
            "API"
            "Contributing"
            "Changelog"
            "License"
          )

          for section in "${KEY_SECTIONS[@]}"; do
            if grep -r -i "$section" docs/ README.md 2>/dev/null; then
              echo "- ✅ $section" >> $GITHUB_STEP_SUMMARY
            else
              echo "- ❌ $section (missing)" >> $GITHUB_STEP_SUMMARY
            fi
          done

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Recommendations" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Add missing sections for comprehensive documentation" >> $GITHUB_STEP_SUMMARY
          echo "- Include screenshots and diagrams for better UX" >> $GITHUB_STEP_SUMMARY
          echo "- Provide code examples for API documentation" >> $GITHUB_STEP_SUMMARY
          echo "- Regular review and update of documentation" >> $GITHUB_STEP_SUMMARY
