name: Package and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to package (e.g., v1.0.0)'
        required: true
        default: 'v0.1.0'
      create_release:
        description: 'Create GitHub release'
        required: false
        default: true
        type: boolean

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write
  packages: write

env:
  APP_NAME: sast-readium

jobs:
  # Extract version information
  version-info:
    name: Extract Version Info
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      version: ${{ steps.version.outputs.version }}
      version_number: ${{ steps.version.outputs.version_number }}
      is_prerelease: ${{ steps.version.outputs.is_prerelease }}

    steps:
      - name: Extract version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${{ github.ref_name }}"
          fi

          VERSION_NUMBER=${VERSION#v}
          IS_PRERELEASE=false

          if [[ "$VERSION" =~ (alpha|beta|rc) ]]; then
            IS_PRERELEASE=true
          fi

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "version_number=$VERSION_NUMBER" >> $GITHUB_OUTPUT
          echo "is_prerelease=$IS_PRERELEASE" >> $GITHUB_OUTPUT

          echo "Version: $VERSION"
          echo "Version Number: $VERSION_NUMBER"
          echo "Is Prerelease: $IS_PRERELEASE"

  # Trigger platform builds if needed
  trigger-builds:
    name: Trigger Platform Builds
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: version-info
    if: false
    outputs:
      build_triggered: ${{ steps.trigger.outputs.build_triggered }}

    steps:
      - name: Trigger platform workflows
        id: trigger
        run: |
          echo "Triggering platform-specific builds..."
          echo "build_triggered=true" >> $GITHUB_OUTPUT
          # Note: In a real scenario, you might trigger the platform workflows here
          # For now, we'll proceed with the fallback build approach

  # Build all platforms for packaging (fallback when not using platform workflows)
  build-for-packaging:
    name: Build ${{ matrix.platform }}-${{ matrix.arch }}
    runs-on: ${{ matrix.runner }}
    timeout-minutes: 90
    needs: version-info
    if: false
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux x64 - System packages (preferred)
          - platform: linux
            arch: x64
            runner: ubuntu-latest
            preset: Release-Unix
            package_manager: apt
            packages: qt6-base-dev qt6-svg-dev qt6-tools-dev libpoppler-qt6-dev build-essential cmake ninja-build pkg-config ccache

          # macOS Universal (Intel + Apple Silicon)
          - platform: macos
            arch: universal
            runner: macos-latest
            preset: Release-Unix
            package_manager: brew
            packages: cmake ninja qt@6 poppler-qt5 pkg-config ccache

          # Windows x64 - MSYS2 preferred, vcpkg fallback
          - platform: windows
            arch: x64
            runner: windows-latest
            preset: Release-MSYS2
            use_msys2: true

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'

      # Set up Python for potential pre-commit usage
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # System package builds (Linux/macOS)
      - name: Install system dependencies
        if: matrix.package_manager
        run: |
          if [ "${{ matrix.package_manager }}" = "apt" ]; then
            sudo apt update
            sudo apt install -y ${{ matrix.packages }}
          elif [ "${{ matrix.package_manager }}" = "brew" ]; then
            export HOMEBREW_NO_AUTO_UPDATE=1
            brew install ${{ matrix.packages }}
          fi
        shell: bash

      # MSYS2 setup for Windows
      - name: Setup MSYS2 (Windows)
        if: matrix.use_msys2
        uses: msys2/setup-msys2@v2
        with:
          msystem: mingw64
          update: true
          install: >-
            mingw-w64-x86_64-cmake
            mingw-w64-x86_64-ninja
            mingw-w64-x86_64-gcc
            mingw-w64-x86_64-qt6-base
            mingw-w64-x86_64-qt6-svg
            mingw-w64-x86_64-qt6-tools
            mingw-w64-x86_64-poppler-qt6
            mingw-w64-x86_64-pkg-config
            git

      - name: Configure CMake
        run: |
          if [ "${{ matrix.platform }}" = "macos" ] && [ "${{ matrix.arch }}" = "universal" ]; then
            export PKG_CONFIG_PATH="$(brew --prefix qt@6)/lib/pkgconfig:$PKG_CONFIG_PATH"
            cmake --preset=${{ matrix.preset }} -DCMAKE_OSX_ARCHITECTURES="x86_64;arm64" -DUSE_VCPKG=OFF
          elif [ "${{ matrix.platform }}" = "linux" ]; then
            cmake --preset=${{ matrix.preset }} -DUSE_VCPKG=OFF
          elif [ "${{ matrix.platform }}" = "windows" ] && [ "${{ matrix.use_msys2 }}" = "true" ]; then
            cmake --preset=${{ matrix.preset }}
          fi
        shell: bash

      - name: Build
        run: |
          cmake --build --preset=${{ matrix.preset }} --parallel 4
        shell: bash

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-${{ matrix.platform }}-${{ matrix.arch }}
          path: |
            build/Release*/app/
          retention-days: 1

  # Package for Linux (.deb, .rpm, AppImage) via CPack
  package-linux:
    name: Package Linux
    runs-on: ubuntu-latest
    timeout-minutes: 60
    needs: [version-info]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install build and packaging dependencies
        run: |
          sudo apt update
          sudo apt install -y \
            qt6-base-dev qt6-svg-dev qt6-tools-dev libpoppler-qt6-dev \
            build-essential cmake ninja-build pkg-config ccache \
            dpkg-dev rpm fakeroot
        shell: bash

      - name: Install AppImage tools
        run: |
          wget https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage
          chmod +x appimagetool-x86_64.AppImage
          sudo mv appimagetool-x86_64.AppImage /usr/local/bin/appimagetool
        shell: bash

      - name: Configure CMake (Release-Unix with packaging)
        run: cmake --preset=Release-Unix
        shell: bash

      - name: Build and package with CPack
        run: cmake --build --preset=Release-Unix --target package --parallel 4
        shell: bash

      - name: Upload Linux packages
        uses: actions/upload-artifact@v4
        with:
          name: packages-linux
          path: |
            build/Release/*.deb
            build/Release/*.rpm
            build/Release/*.AppImage

  # Package for macOS (.dmg) via CPack
  package-macos:
    name: Package macOS
    runs-on: macos-latest
    timeout-minutes: 60
    needs: [version-info]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install build dependencies
        run: |
          brew install cmake ninja qt@6 pkg-config
        shell: bash

      - name: Configure CMake (universal, Release-Unix with packaging)
        run: |
          export PKG_CONFIG_PATH="$(brew --prefix qt@6)/lib/pkgconfig:$PKG_CONFIG_PATH"
          cmake --preset=Release-Unix -DCMAKE_OSX_ARCHITECTURES="x86_64;arm64"
        shell: bash

      - name: Build and package with CPack
        run: cmake --build --preset=Release-Unix --target package --parallel 4
        shell: bash

      - name: Upload macOS package
        uses: actions/upload-artifact@v4
        with:
          name: packages-macos
          path: |
            build/Release/*.dmg

  # Package for Windows (installer/portable) via CPack
  package-windows:
    name: Package Windows
    runs-on: windows-latest
    timeout-minutes: 60
    needs: [version-info]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup MSYS2 (MinGW64)
        uses: msys2/setup-msys2@v2
        with:
          msystem: mingw64
          update: true
          install: >-
            mingw-w64-x86_64-cmake
            mingw-w64-x86_64-ninja
            mingw-w64-x86_64-gcc
            mingw-w64-x86_64-qt6-base
            mingw-w64-x86_64-qt6-svg
            mingw-w64-x86_64-qt6-tools
            mingw-w64-x86_64-poppler-qt6
            mingw-w64-x86_64-pkg-config
            git

      - name: Configure CMake (Release-MSYS2 with packaging)
        shell: msys2 {0}
        run: cmake --preset=Release-MSYS2

      - name: Build and package with CPack
        shell: msys2 {0}
        run: cmake --build --preset=Release-MSYS2 --target package --parallel 4

      - name: Upload Windows packages
        uses: actions/upload-artifact@v4
        with:
          name: packages-windows
          path: |
            build/Release-MSYS2/*.exe
            build/Release-MSYS2/*.zip
            build/Release-MSYS2/*.msi

  # Create GitHub Release
  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: [version-info, package-linux, package-macos, package-windows]
    if: github.event.inputs.create_release == 'true' || github.event_name == 'push'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download all packages
        uses: actions/download-artifact@v4
        with:
          path: packages/

      - name: Generate release notes
        id: release_notes
        run: |
          # Generate changelog since last tag
          LAST_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")

          if [ -n "$LAST_TAG" ]; then
            echo "## Changes since $LAST_TAG" > release_notes.md
            echo "" >> release_notes.md
            git log --pretty=format:"- %s (%h)" $LAST_TAG..HEAD >> release_notes.md
          else
            echo "## Initial Release" > release_notes.md
            echo "" >> release_notes.md
            echo "First release of SAST Readium - a modern Qt6-based PDF reader." >> release_notes.md
          fi

          echo "" >> release_notes.md
          echo "## Platform Support" >> release_notes.md
          echo "" >> release_notes.md
          echo "### Supported Platforms" >> release_notes.md
          echo "- **Linux x64**: .deb, .rpm, AppImage" >> release_notes.md
          echo "- **macOS Universal**: .dmg (Intel + Apple Silicon)" >> release_notes.md
          echo "- **Windows x64**: .msi installer" >> release_notes.md
          echo "" >> release_notes.md
          echo "### Installation" >> release_notes.md
          echo "" >> release_notes.md
          echo "**Linux:**" >> release_notes.md
          echo "- Ubuntu/Debian: Download and install the .deb package" >> release_notes.md
          echo "- RHEL/CentOS/Fedora: Download and install the .rpm package" >> release_notes.md
          echo "- Universal: Download and run the AppImage" >> release_notes.md
          echo "" >> release_notes.md
          echo "**macOS:**" >> release_notes.md
          echo "- Download the .dmg file and drag to Applications folder" >> release_notes.md
          echo "- Supports both Intel and Apple Silicon Macs" >> release_notes.md
          echo "" >> release_notes.md
          echo "**Windows:**" >> release_notes.md
          echo "- Download and run the .msi installer" >> release_notes.md
          echo "- Requires Windows 10 or later" >> release_notes.md
          echo "" >> release_notes.md
          echo "## Dependencies" >> release_notes.md
          echo "" >> release_notes.md
          echo "- Qt6 (Core, Gui, Widgets, Svg)" >> release_notes.md
          echo "- Poppler-Qt6 for PDF rendering" >> release_notes.md
          echo "" >> release_notes.md
          echo "System packages are preferred over vcpkg for better performance." >> release_notes.md

      - name: Organize release assets
        run: |
          mkdir -p release_assets

          # Copy and rename packages with consistent naming
          find packages/ -name "*.deb" -exec cp {} release_assets/ \;
          find packages/ -name "*.rpm" -exec cp {} release_assets/ \;
          find packages/ -name "*.AppImage" -exec cp {} release_assets/ \;
          find packages/ -name "*.dmg" -exec cp {} release_assets/ \;
          find packages/ -name "*.msi" -exec cp {} release_assets/ \;

          # List all assets
          echo "Release assets:"
          ls -la release_assets/

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.version-info.outputs.version }}
          name: SAST Readium ${{ needs.version-info.outputs.version }}
          body_path: release_notes.md
          prerelease: ${{ needs.version-info.outputs.is_prerelease }}
          files: |
            release_assets/*
          generate_release_notes: true
          append_body: true

      - name: Update package repositories
        if: needs.version-info.outputs.is_prerelease == 'false'
        run: |
          echo "ðŸš€ Release ${{ needs.version-info.outputs.version }} created successfully!"
          echo ""
          echo "ðŸ“¦ Available packages:"
          echo "- Linux: .deb, .rpm, AppImage"
          echo "- macOS: .dmg (Universal Binary)"
          echo "- Windows: .msi installer"
          echo ""
          echo "ðŸ”— Release URL: https://github.com/${{ github.repository }}/releases/tag/${{ needs.version-info.outputs.version }}"
